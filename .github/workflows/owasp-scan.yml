name: OWASP Scan Workflow

on:
  workflow_dispatch:

jobs:
  run-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      # 1) Checkout full history for branch pushes
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) Trigger OWASP scan and capture the ID
      - name: Trigger OWASP Scan
        id: trigger
        run: |
          echo "Starting OWASP scan..."
          RESPONSE=$(curl -sS -X POST "http://34.135.194.57:28291/start_scan" \
            -H "Content-Type: application/json" \
            --data-raw '{
              "options": {
                "categories": ["Jailbreak","OWASP1","OWASP2","OWASP3","OWASP4","OWASP5","OWASP6","OWASP7","OWASP8","OWASP9","OWASP10"],
                "quality_level": 0,
                "response_details_level": 0,
                "languages": "en",
                "attack_type": [0],
                "repeat_count": 1,
                "risk_categories": [],
                "custom_risk": null,
                "owasp_version": "2024"
              },
              "template": {"prefix": "", "postfix": "", "config_name": null},
              "restrictions": {
                "total_limit": null,
                "attack_type_limit": [null,null,null,null],
                "delete_duplicates": false
              },
              "model": {
                "provider": "Preconfigured models",
                "model_name": "echo",
                "model_type": "local",
                "custom_host": "",
                "api_key": ""
              },
              "files": {},
              "debug": true
            }')
          echo "Response payload: $RESPONSE"
          SCAN_ID=$(echo "$RESPONSE" | jq -r '.id // empty')
          if [[ -z "$SCAN_ID" ]]; then
            echo "Failed to get scan ID from response"; exit 1
          fi
          echo "SCAN_ID=$SCAN_ID" >> $GITHUB_ENV

      # 3) Poll until status=Done (or bail on Error/timeout)
      - name: Wait for scan to finish
        timeout-minutes: 150
        run: |
          for i in {1..260}; do
            STATUS_RESPONSE=$(curl -sS "http://34.135.194.57:28291/check_task" \
              -H "Content-Type: application/json" \
              -d "{\"id\":\"${SCAN_ID}\"}")
            echo "Status response #$i: $STATUS_RESPONSE"
            STATUS=$(echo "$STATUS_RESPONSE" | jq -r '.status // empty')
            if [[ "$STATUS" == "Done" ]]; then
              REPORT_FILE=$(echo "$STATUS_RESPONSE" | jq -r '.Result // empty')
              echo "Scan completed, report file: $REPORT_FILE"
              echo "REPORT_FILE=$REPORT_FILE" >> $GITHUB_ENV
              break
            elif [[ "$STATUS" == "Error" ]]; then
              echo "Scan returned Error status"; exit 1
            fi
            sleep 30
          done

          if [[ -z "${REPORT_FILE}" ]]; then
            echo "Scan did not finish within timeout"; exit 1
          fi

      # 4) Download the Excel report
      - name: Download Excel Report
        if: env.REPORT_FILE != ''
        run: |
          curl -fSL -o report.xlsx "http://34.135.194.57:28291/download-file/${REPORT_FILE}"
          echo "Downloaded report.xlsx"
          echo "REPORT_FILE_PATH=report.xlsx" >> $GITHUB_ENV

      # 5) (Optional) Upload the raw Excel for reference
      - name: Upload OWASP Excel
        if: env.REPORT_FILE_PATH != ''
        uses: actions/upload-artifact@v4
        with:
          name: OWASP-Scan-Excel-Report
          path: report.xlsx

      # 6) Generate Allure JSON from that Excel
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: pip install pandas openpyxl

      - name: Generate Allure JSON
        run: python .github/scripts/generate_allure_results.py "${REPORT_FILE_PATH}"
        env:
          REPORT_FILE_PATH: ${{ env.REPORT_FILE_PATH }}
      # 7) PRE‑CREATE the Allure directories
      - name: Prepare Allure folders
        run: |
          mkdir -p allure-results
          mkdir -p allure-report
          mkdir -p allure-history

      # 8) Fetch last run’s history (first run will skip)
      - name: Download previous Allure history
        uses: actions/download-artifact@v4
        with:
          name: allure-history
          path: allure-history
          fail-on-missing: false

      # 9) Generate & merge history into HTML
      - name: Generate Allure HTML Report
        uses: simple-elf/allure-report-action@v1.8
        with:
          allure_results: allure-results
          allure_report: allure-report
          allure_history: allure-history
          keep_reports: 20

      # 10) Upload final HTML + updated history
      - name: Upload Allure HTML
        uses: actions/upload-artifact@v4
        with:
          name: Allure-HTML-Report
          path: allure-report/

      - name: Upload Allure History
        uses: actions/upload-artifact@v4
        with:
          name: allure-history
          path: allure-history/

      # 11) Deploy static site to reports branch for CDN hosting
      - name: Deploy to reports branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout --orphan reports
          git rm -rf .
          cp -r allure-report/* .
          git add .
          git commit -m "Deploy Allure report – run #${{ github.run_number }}"
          git push -f origin reports
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
